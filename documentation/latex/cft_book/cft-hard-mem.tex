% -*- latex -*-
\label{chap:mem}
\section{Introduction}

The Memory Board hosts the CFT's main memory. Both volatile (RAM) and
non-volatile (ROM, EPROM, EEPROM or Flash) memory may be accommodated on the
board.

The original design of the board accommodates up to 1,024~kWords, but since
this board is very simple, it is relatively easy to add another 512 or
1,024~kWords. Alternatively, two separate boards may be built to provide the
full amount of memory for the computer.

The memory board is designated \gls{MEM}, although it is not a system device,
and is unique.

\section{Design}

The CFT has a 21-bit physical memory address space, which allows for $2^{21}
=$~ 2,097,152 16-bit words.

The memory board provides:

\begin{itemize}
\item An address decoder that works in the extended (physical) memory address
  space.
\item Two to four banks of memory.
\item An optional buffer and status LEDs to indicate state.
\end{itemize}

The current design implements two banks, independently configurable via
jumpers. One bank is reserved for ROM, the other for RAM. The ROM bank accepts
JEDEC-style ICs in 32-pin \gls{PLCC} packages. It features a jumper to allow
the Flash \ns{WE} signal to be driven by the CFT in normal writes. This allows
the ROMs to be reprogrammed in-circuit by either the \gls{DEB} board or the CFT
computer itself (provided, of course, the software to do so is running purely
from RAM).

RAM banks are simpler, but they are built for 32-pin \gls{DIP} packages.

In the current design, all banks are 16 bits by 4 Mbits, which makes 512
kWords. This design decision is partially responsible for the increased
importance of the \gls{MBU} card. The reason is simple: 4 Mbit devices were
easy to find and the cheapest option at the time of purchase.

Since these chips are 8 bits wide, two chips are used in parallel to provide
16-bit word storage, forming two-chip memory banks.

\section{Theory of Operation}

Access to the card's facilities is possible via a standard address decoder
built from an equally standard 74HC138 3:8 demultiplexer. The '138 decodes
\AEXTn{7} and \AEXTn{6} when \ns{MEM} is asserted, with \ns{R} and \ns{W} being
don't care values. These are decoded into one to four active-low chip select
lines, \nBUS{RAMEN}{0}, \nBUS{ROMEN}{0}, \nBUS{RAMEN}{1}, and \nBUS{ROMEN}{1}
as follows:

\begin{center}
  \zebra
  \begin{tabular}{*{6}{>{\textsf\bgroup}c<{\egroup}}l}
    %\noalign{\smallskip}\hline\noalign{\smallskip}
    %\\\hline
    \AEXTn{7–6} & \ns{MEM} & \nBUS{RAMEN}{0} & \nBUS{ROMEN}{0} & \nBUS{RAMEN}{1} & \nBUS{ROMEN}{1} \\
    %\noalign{\smallskip}\hline\noalign{\smallskip}
    \hline
    X  & 1  &    1 & 1 & 1 & 1 \\
    00 & 0  &    0 & 1 & 1 & 1 \\
    01 & 0  &    1 & 0 & 1 & 1 \\
    10 & 0  &    1 & 1 & 0 & 1 \\
    11 & 0  &    1 & 1 & 1 & 0 \\
    \hline
  \end{tabular}
\end{center}

These chip select lines can be routed, optionally via jumper sets for easier
reconfiguration, to up to the \ns{CE} (chip enable/select) signals of up to four banks of memory.

Each of these banks comprises a pair of either static 8-bit RAM ICs, or (in the
current design) Flash ROM. The \ns{OE} signals are driven by the CFT's \ns{R}
pulse. The \ns{WE} signals are driven by the \ns{W} strobe, itself controlled
by the control unit's \ns{WEN} signal. ROM banks intended to take Flash devices
can have their \ns{OE} signals disconnected from \ns{W} as a means of write
protection. When connected, Flash devices require a particular ‘magic’ sequence
of writes to erase chip sectors, and a separate sequence to allow
rewriting. Thus, Flash memory cannot be overwritten by mistake.

Each of the 4 Mbit devices accepts an 19-bit address which is derived from the
extended memory vector shown in~\fcf{fig:mem-bits}. This is made up of the
least significant 13 bits of the Address Bus (\ABUSn{0–12}) and the least
significant 6 bits of the \ps{AEXT} bus (\AEXTn{0–5}) generated by the
\gls{MBU} card. For more details on how and why this is done, please
consult\ccf{sec:mbu-theory}.

For debugging and testing, an optional inverting buffer shows the chip
selection state of the board, along with \ns{R} and \ns{W}. As designed, the
card uses four of the eight buffers. For a full four-bank card, another two may
be used, along with additional LEDs and resistors.

\begin{figure}[tb]
  \centering
  \inputfigure{figure-mem-bits}
  \caption{\label{fig:mem-bits}Physical address space as seen by the memory board.}
\end{figure}


\section{Customising the Card}

The buffer and state-displaying LEDs are completely optional and may be left
out entirely.

If 4 MBit (512 kWord) parts are installed, the board needs two ICs per
bank. Additional banks may be fitted and attached to the appropriate lines of
the address decoder.

If smaller memories are used in either bank, any number of sockets may be
installed, for whatever type of memory is available. The memory should have an
SRAM-like interface, of course.JEDEC-standard pin-outs give more options and
are preferable.

The CFT ROM detects memory via heuristics, not via DIP switches or hardwired
settings, so any mapping of RAM and ROM will work. However, the mapping shown
in~\fcf{fig:mem-physmap} is assumed to be in place, and the initial values of
the \gls{MBU} registers reflect this.

One benefit of colocating multiple banks of memory on the same card is that
only one decoder chip is needed. This reduces chip count by one to three units,
and also saves considerable amounts of board estate.

Please note that the two-bank design was intentional: when the card was
initially designed, the need for memory-mapped devices was foreseen and
decoding is {\em much\/} simpler if all memory have the same size. 512 kWords
of RAM and ROM should be enough for the CFT.


\begin{figure}[tb]
  \centering
  \inputfigure{figure-mem-physmap}
  \caption[Physical memory map of the
    CFT]{\label{fig:mem-physmap}Physical memory map of the CFT. The
    memory board implements three of the four banks. Of these, only
    one RAM bank and the ROM bank are populated with memory. The
    remaining bank (RAM Bank 1) is not populated. The fourth bank,
    which is not implemented by the memory board, is for memory mapped
    I/O like the VDU card.}
\end{figure}


\section{Implementation}

The implementation of the memory board diverges from the schematics
slightly. As shown in~\fcf{fig:mem-physmap}, there are three banks
rather than two. This implies that only one memory board can be
installed in the system. The jumpers have thus been removed since
configuration is no longer needed. The memory banks are hard-wired as
follows:

\begin{description}
  \item{\bfseries Bank 0 (\hex{000000}–\hex{07FFFF})} contains
    512~kWords of RAM.
  \item{\bfseries Bank 1 (\hex{080000}–\hex{0FFFFF})} is reserved for
    memory expansion. Two sockets for 32-pin, 524,288×8 static RAM
    chips are provided. This allows doubling RAM if necessary.
  \item{\bfseries Bank 2 (\hex{100000}–\hex{17FFFF})} contains
    512~kWords of ROM.
  \item{\bfseries Bank 3 (\hex{180000}–\hex{1FFFFF})} is not decoded
    by the memory board. This bank may be shared among devices that
    require memory-mapped I/O.
\end{description}

There is also an additional indicator LED for the extra bank. The
Flash program protect jumper is still present. The board also adds
pull-down resistors for \AEXTn{0–7} to ensure a sane value in the
absence of an extended memory manager of some sort (for instance, when
only the \gls{DEB} board is present on the bus).

\section{Schematics}

The following page shows the full schematic drawing of the \gls{MEM}
board. Please note that this is the two-bank board with jumpers for
bank selection and not the memory board as constructed.

\cleardoublepage
\includeschns{24}{Memory (RAM and ROM)}{sch2:memory}
